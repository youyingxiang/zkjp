{include file="layout/top" /}
{include file="layout/header" /}
<div class="page-content02">
    <a href="{:get_img_url($ad['提交工单-banner'][0]['url'])}">
        <div class="page-banner check-banner" style="background-image:url({$ad['提交工单-banner'][0]['img']});">
            <div class="txt">
                {$ad['提交工单-banner'][0]['title']}
            </div>
        </div>
    </a>
    <div class="w1400 slideIn02">
        <div class="position"><a href="{:url('/')}">{$Think.lang.home}</a> > <a href="{:url('/service')}">{$Think.lang.service}</a> > <a href="{:url('/online_support')}">{$Think.lang.online_support}</a> > {$title}</div>
        <div class="height20"></div>
        <div class="weixiu-content">
            <div class="item02">
                <div class="weixiu-title">{$Think.lang.customer_info} <a class="item02-edit" href="javascript:void(0)">[{$Think.lang.edit}]</a></div>
                <div class="table-box clearfix">
                    <table cellpadding="0" cellspacing="0" border="0" width="100%">
                        <thead>
                            <tr>
                                <td>{$Think.lang.company_name}</td>{/* 公司名称 */}
                                <td>{$Think.lang.contact_p}</td>{/* 联系人 */}
                                <td>{$Think.lang.email}</td>{/* 邮箱 */}
                                <td>{$Think.lang.tel}</td>{/* 电话 */}
                                <td>{$Think.lang.address}</td>{/* 公司地址 */}
                            </tr>
                        </thead>
                        <tbody>
                            <tr id='tr-info'>
                                <td>
                                    {if condition="!empty(json_decode(cookie('user_info'),true))"}{:json_decode(cookie('user_info'),true)['companyName']}{/if}
                                </td>
                                <td>
                                    {if condition="!empty(json_decode(cookie('user_info'),true))"}{:json_decode(cookie('user_info'),true)['contactName']}{/if}
                                </td>
                                <td>
                                    {if condition="!empty(json_decode(cookie('user_info'),true))"}{:json_decode(cookie('user_info'),true)['email']}{/if}
                                </td>
                                <td>
                                    {if condition="!empty(json_decode(cookie('user_info'),true))"}{:json_decode(cookie('user_info'),true)['tel']}{/if}
                                </td>
                                <td>
                                    {if condition="!empty(json_decode(cookie('user_info'),true)['address'])"}{:json_decode(cookie('user_info'),true)['address']}{/if}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="item02-box">
                    <div class="list" style="width:50%;">
                        <div class="left"><span>*</span>{$Think.lang.company_name}</div>{/* 公司名称 */}
                        <div class="right"><input class="text" name='companyName'  type="text"></div>
                    </div>
                    <div class="list" style="width:50%;">
                        <div class="left"><span>*</span>{$Think.lang.contact_p}</div>{/* 联系人 */}
                        <div class="right"><input class="text" name='contactName' type="text"></div>
                    </div>
                    <div class="list" style="width:50%;">
                        <div class="left"><span>*</span>{$Think.lang.address}</div>{/* 公司地址 */}
                        <div class="right"><input class="text"  type="text"></div>
                    </div>
                    <div class="list">
                        <div class="right"><input type="button" value="{$Think.lang.save}" style="background:#78bc27;color:#fff;" class="btn item02-save"></div>
                    </div>
                </div>
            </div>
            <div class="item04 clearfix">
                <div class="weixiu-title"><span>{$Think.lang.ticket_detail}</span></div>{/* 问题详情 */}
                <div class="list fl" style="width:33.33%;">
                    <div class="left"><span>*</span>{$Think.lang.questionType}</div> {/* 类别 */}
                    <div class="right">
                        <select id='questionType'>
                            {volist name='$problem_cat' id='vo'}
                                <option  value="{$vo.problemCategory}">{$vo.problemCategory}</option>
                            {/volist} 
                        </select>
                    </div>
                </div>
                <div class="clear"></div>
                <div class="list fl" style="width:33.33%;">
                    <div class="left"><span>*</span>{$Think.lang.questTitle}</div>{/* 问题 */}
                    <div class="right"><input class="text sn" id='questTitle' placeholder="Please input subject" type="text"></div>
                </div>
                <div class="clear"></div>
                <div class="list">
                    <div class="left"><span>*</span>{$Think.lang.content}</div>{/* 描述 */}
                    <div class="right"><textarea class="ms" id='content' placeholder="Please kindly show us the details of your device/software. Including but not limited to the device name/SN/firmware version/software name/software version/SDK version. And a full description of how to reproduce the problem you are experiencing."></textarea></div>
                </div>
                <div class="list fl" style="width:50%;">
                    <div class="left">Attachment</div>
                    <div class="right">
                        <span class="upload">Please select attachment</span>
                        <ul class="upload-box upload_path" style="top:35px">
                            
                        </ul>
                    </div>
                </div>
                <div class="list fl" style="width:50%;padding-left:0;">
                    <div class="right">
                        {$Think.lang.wx_msg}   {/* 温馨提示*/}
                    </div> 
                </div>
                <div class="clear"></div>
                <div class="list clearfix">
                    <div class="right"><input class="text yzm fl" id='verify' type="text" placeholder="{$Think.lang.verify}"><img src="{:captcha_src()}" style="height:45px"  id="code" alt="captcha" onclick="this.src='{:captcha_src()}?rnd=' + Math.random();" /></div>
                </div>
                <div class="list">
                    <div class="right"><input type="button" value="{$Think.lang.submit}" style="background:#78bc27;color:#fff;" class="btn sbm"></div>
                </div>
                <input id="fileupload" type="file" name="imgFile"  data-url="https://service.zkteco.com:8443/apiv1/upload/uploadFile.action" multiple>
            </div>
        </div>
    </div>
</div>
<?php $compatible = 1;?>
{include file="layout/footer" /}
{include file="layout/js" /}
<script src="{$Think.HOME_JS}/upload/jquery.ui.widget.js"></script>
<script src="{$Think.HOME_JS}/upload/jquery.iframe-transport.js"></script>
<script src="{$Think.HOME_JS}/upload/jquery.fileupload.js"></script>
<script>
   // $("#code").trigger('click');        //linux 验证码需要触发一次
    $('#fileupload').hide();
    $('#fileupload').fileupload({
        dataType: 'json',
        add: function (e,data) {
            var mxsize = 5*1024*1024;
            //var mxlenget = $('.fileUpload_').length;
            var mxlenget = $('.upload_path').children("input(type='hidden')").length;
            if (parseInt(data.files[0].size) > parseInt(mxsize)) {
                showErrMsg('Max. 5mb');
                return;
            } else if (parseInt(mxlenget)>3) {
                showErrMsg('Max. 4 attachments');
                return;
            } else {
                loading_msg("{$Think.lang.commit_now}");
                data.submit();
            }
        },
        done: function (e, data) {
            layer.close(index);
            if (data.result.code == '00000000') {
                var d = data.result.payload.results;
                var attchmentJson = "{'fileKey':'"+d.fileKey +"','name':'"+d.name+"','time':'"+d.time +"','realPath':'"+d.realPath+"'},";
                var html = '<li>'+d.name+'<i onclick="delete_self(this)"></i></li><input type="hidden" value='+attchmentJson+'>';
                $('.upload_path').append(html);
                showOkTime(data.result.msg,3);
            } else {
                showErrMsg(data.result.msg);
            }
        }
    });

     $(".btn.sbm").on('click',function(){
        var i1 = 0;
        var info = [];
        var flag = 0;
        $('#tr-info td').each(function(){               //客户信息
            info[i1] = $(this).text().trim();
            if ($(this).text().trim().length == 0) {
                flag = 1;
            }
            i1++;
        })
        var i2 = 0;
        var uploadfile='';
        $(".upload_path input[type='hidden']").each(function(){               //上传信息
            if ($(this).val().trim().length>0) {
                uploadfile += $(this).val().trim();
            }
        })
        var questionType = $('#questionType').val().trim();       //分类
        if (questionType.length == 0) {
             flag = 1;
        }
        var questTitle = $('#questTitle').val().trim();       //分类标题
        if (questTitle.length == 0) {
             flag = 1;
        }
        var content = $('#content').val().trim();       //内容
        if (content.length == 0) {
             flag = 1;
        }
        var verify = $('#verify').val().trim();
        if (verify.length == 0) {
             flag = 1;
        }
        if (flag == 1) {
            showErrMsg("{$Think.lang.err6}");
            return;
        } else {
            loading_msg("{$Think.lang.commit_now}");
            $.ajax({
                url: "{:url('Service/ticket_commit')}", 
                data: {"info":JSON.stringify(info),'uploadfile':uploadfile,'questionType':questionType,'questTitle':questTitle,'content':content,'verify':verify,'token':"{$Request.token}"},
                type:'post', 
                dataType: "json", 
                error:function(data){
                    layer.close(index);
                    $('#code').trigger('click');
                    showErrMsg("{$Think.lang.ajax_err}");
                    return;
                },  
                success:function(result){
                    layer.close(index);
                    $('#code').trigger('click');
                    if (result.status == 1) {
                        window.location.href="{:url('index/Service/ticket_finish')}";
                    } else {
                        showErrMsg(result.info);
                    }           
                },
            })
        }


    })
    function loading_msg(msg){
        index = layer.msg(msg, {
            icon: 16,
            shade: 0.5,
            time: 30000,
            shadeClose: false 
        });
    }
    $('.upload').on('click',function(){
        //console.log('123');
        obj = $(this);
        $('#fileupload').trigger('click');
    })

    function delete_self(obj)
    {
        $(obj).parent().next().remove();
        $(obj).parent().remove();
    }

    $(".item02-edit").on("click",function(){
        $(".item02-box").slideToggle(150);
        $(".weixiu-content .item02 .item02-box .list").eq(0).find("input").val($(".item02 .table-box table tbody tr td").eq(0).text().trim());
        $(".weixiu-content .item02 .item02-box .list").eq(1).find("input").val($(".item02 .table-box table tbody tr td").eq(1).text().trim());
        $(".weixiu-content .item02 .item02-box .list").eq(2).find("input").val($(".item02 .table-box table tbody tr td").eq(4).text().trim());
    })
    //保存事件
    $(".item02-save").on("click",function(){
        if ($(".weixiu-content .item02 .item02-box .list").eq(0).find("input").val().trim().length == 0) {
            showErrMsg('{$Think.lang.err1}');
            return;
        }
        if ($(".weixiu-content .item02 .item02-box .list").eq(1).find("input").val().trim().length == 0) {
            showErrMsg('{$Think.lang.err2}');
            return;
        }
        if ($(".weixiu-content .item02 .item02-box .list").eq(2).find("input").val().trim().length == 0) {
            showErrMsg('{$Think.lang.err5}');
            return;
        }
        $(".item02-box").slideUp(150);
        $(".item02 .table-box table tbody tr td").eq(0).text($(".weixiu-content .item02 .item02-box .list").eq(0).find("input").val().trim());
        $(".item02 .table-box table tbody tr td").eq(1).text($(".weixiu-content .item02 .item02-box .list").eq(1).find("input").val().trim());
        $(".item02 .table-box table tbody tr td").eq(4).text($(".weixiu-content .item02 .item02-box .list").eq(2).find("input").val().trim());
    })
</script>
</body>
</html>
